!function(){function a(){var a=this,b=2,c=0;a.texture=(new THREE.TextureLoader).load(a.textureURL,function(){c+=1,c==b&&(publish("world/loadComplete"),a.created=!0)});var d=new THREE.TerrainLoader;d.load(a.terrainURL,function(d){a.terrainData=d,c+=1,c==b&&(publish("world/loadComplete"),a.created=!0)})}function b(a){var b=this,c=b.worldWidth/b.xNum,d=b.worldHeight/b.yNum,e=Math.floor(a.x/c),f=b.yNum-Math.floor(a.y/d),g=f*(b.xNum+1)+e,h=g+1,i=(f+1)*(b.xNum+1)+e,j=i+1;return[g,h,i,j]}function c(a,b,c){var d=(b.y-a.y)*(c.z-a.z)-(b.z-a.z)*(c.y-a.y),e=(b.z-a.z)*(c.x-a.x)-(b.x-a.x)*(c.z-a.z),f=(b.x-a.x)*(c.y-a.y)-(b.y-a.y)*(c.x-a.x),g=0-(d*a.x+e*a.y+f*a.z);return{a:d,b:e,c:f,d:g}}this.World=function(){if(!arguments[0])throw"settings are required";var a=arguments[0];for(var b in a){var c=a[b];this[b]=c}this.texture=null,this.terrainData=null,this.geometry=null,this.created=!1},World.prototype.create=function(){var b=this;a.call(b);var c=subscribe("world/loadComplete",function(){unsubscribe(c),b.geometry=new THREE.PlaneGeometry(b.worldWidth,b.worldHeight,b.xNum,b.yNum);for(var a=0,d=b.geometry.vertices.length;d>a;a++)b.geometry.vertices[a].z=b.terrainData[a]/65535*110+2;var e=new THREE.MeshLambertMaterial({color:16777215,map:b.texture,side:THREE.DoubleSide}),f=new THREE.Mesh(b.geometry,e);b.scene.add(f),publish("world/created")})},World.prototype.latlngToCoordinate=function(a){var b=this,c=b.latlngBox[1],d=b.latlngBox[0],e={},f=(c[1]-a.lat)/(c[1]-c[0]),g=f*b.worldHeight;e.y=g-b.worldHeight/2;var h=(a.lng-d[0])/(d[1]-d[0]),i=h*b.worldWidth;return e.x=i-b.worldWidth/2,e.z=b.pointPos(e).z,new THREE.Vector3(e.x,e.y,e.z)},World.prototype.pointPos=function(a){var d=this,e={};e.x=a.x+d.worldWidth/2,e.y=a.y+d.worldHeight/2;var f=b.call(d,e),g=d.geometry.vertices[f[0]],h=d.geometry.vertices[f[1]],i=d.geometry.vertices[f[2]],j=d.geometry.vertices[f[3]];c(g,h,i);return a.z=Math.max(g.z,h.z,i.z,j.z),a}}();